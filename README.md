# 粉笔行测辅助工具 - 项目说明

## 项目概述

Tampermonkey 用户脚本，为粉笔网行测错题练习页面提供标注工具和页面优化功能。

**当前版本**: 0.4.2
**@match**: `https://www.fenbi.com/*/exam/error/practice/xingce/*`

---

## 核心功能

### 1. 自动收起答题区
- 页面加载后自动点击"收起"按钮（每 300ms 检测一次）
- 隐藏答题区，扩大题目显示区域
- 自动标记已点击的按钮，避免重复点击
- 实现：`startAutoCollapse()` 函数（第 50-56 行）

### 2. 手动收起按钮（右下角）
- 右下角悬浮的"收起"按钮（鼠标悬停显示）
- 手动触发收起功能，可强制收起所有未收起的按钮
- 包含内存清理机制，确保资源正确释放
- 实现：`createControlButtons()` 函数（第 59-177 行）

### 3. 全屏按钮（右下角）
- 右下角悬浮的"全屏"按钮（鼠标悬停显示）
- 一键进入/退出全屏模式
- 支持浏览器原生全屏 API
- 实现：`createControlButtons()` 函数（第 114-168 行）

### 4. 全屏画布标注系统
点击笔工具按钮后展开全屏画布，支持三种标注模式：

#### 4.1 画笔模式（默认）
- 红色画笔，线宽 2px
- 自由绘制标注
- 记录笔画路径到历史记录
- 自定义画笔光标样式
- 实现：`drawMouseDown`、`drawMouseMove` 函数（第 260-313 行）

#### 4.2 橡皮擦模式
- 使用 `globalCompositeOperation = 'destination-out'` 实现擦除
- 橡皮擦半径 10px
- 同样记录擦除路径到历史记录（可撤销）
- 自定义橡皮擦光标样式（圆形虚线框）
- 实现：`drawMouseDown`、`drawMouseMove` 函数（第 278-312 行）

#### 4.3 撤销功能
- 保存最近 100 条操作历史（`MAX_HISTORY = 100`）
- 点击撤销按钮回退上一步操作
- 支持撤销画笔和橡皮擦操作
- 撤销后自动重绘剩余笔画
- 实现：`undoClick` 函数（第 481-501 行）

#### 4.4 清屏功能
- 一键清除画布上所有内容
- 清空历史记录
- 不清关闭画布，保持笔工具激活状态
- 实现：`clearClick` 函数（第 885-890 行）

#### 4.5 关闭画布按钮
- 独立的关闭按钮（X按钮），仅在笔工具激活时显示
- 点击后关闭画布并重置所有状态
- 实现：`closeClick` 函数（第 922-925 行）

#### 4.6 右键快速切换功能
- 在页面非交互元素上右键可快速打开/关闭笔工具
- 自动排除按钮、链接等可交互元素，避免误触
- 在画布上右键可关闭画布
- 实现：`rightClickToTogglePen` 函数（第 830-874 行）

#### 4.7 面板拖动功能
- 标注工具面板可拖动（点击非按钮区域）
- 自动限制在窗口范围内
- 实现：`panelMouseDown`、`panelMouseMove`、`panelMouseUp` 函数（第 938-973 行）

### 5. UI 交互设计

#### 5.1 标注工具面板（右上角，可拖动）
- **主按钮**：笔工具（点击激活/关闭）
- **子按钮展开**：点击笔工具后展开显示
  - 橡皮擦按钮（🧽 橡皮擦）
  - 撤销按钮（↩ 撤销）
- **独立按钮**：仅在笔工具激活时显示
  - 清屏按钮（清屏（×））：清除所有标注，不关闭画布
  - 关闭按钮（X）：关闭画布并重置状态
- **视觉反馈**：
  - 当前选中模式高亮显示（笔模式：蓝色，橡皮擦模式：橙色）
  - 按钮状态切换（展开/收起）
  - 撤销按钮点击时闪烁反馈

#### 5.2 右下角悬浮按钮组
- **收起按钮**：绿色圆形按钮，鼠标悬停显示
- **全屏按钮**：蓝色圆形按钮，鼠标悬停显示
- 按钮默认隐藏在右侧，悬停时滑出

### 6. 全屏时钟功能
全屏模式下显示可拖动的实时时钟，支持边缘吸附和悬停滑出：

#### 6.1 时钟显示
- 全屏模式下自动显示，退出全屏时自动隐藏
- 实时更新（每秒刷新，显示秒针动画）
- 经典风格设计，深色主题（适合白色背景）
- 初始位置：右上角（top: 75px, right: 55px）
- 实现：`createClock()` 函数（第 182-312 行）

#### 6.2 拖动功能
- 支持鼠标拖动到屏幕任意位置
- 拖动时显示视觉反馈（透明度变化）
- 自动限制在窗口范围内
- 实现：`clockMouseDown`、`clockMouseMove`、`clockMouseUp` 函数（第 318-473 行）

#### 6.3 边缘吸附功能
- 拖动到屏幕边缘附近（30px 内）时自动吸附
- 吸附时隐藏 3/4，只露出 1/4（20px）
- 支持四个方向的吸附：左、右、上、下
- 平滑的过渡动画效果
- 实现：`clockMouseUp` 函数中的边缘检测逻辑（第 435-470 行）

#### 6.4 悬停滑出效果
- 鼠标靠近隐藏的时钟时（30px 范围内）自动滑出
- 滑出时完全显示时钟
- 鼠标离开时自动恢复吸附状态
- 类似全屏按钮的交互体验
- 实现：`clockMouseMove` 函数中的悬停检测逻辑（第 336-404 行）

---

## 技术实现要点

### 1. SPA 路由监听（重要）
**问题**：Tampermonkey 的 `@match` 只在页面初次加载时触发，粉笔网是单页应用，路由切换时脚本不会重新初始化。

**解决方案**（三层防护）：
```javascript
// 1. 劫持 History API
history.pushState = function() {
    originalPushState.apply(this, arguments);
    window.dispatchEvent(new Event('urlchange'));
};

// 2. 监听浏览器原生事件
window.addEventListener('popstate', ...);      // 前进/后退
window.addEventListener('hashchange', ...);    // Hash 路由

// 3. URL 匹配检测
function isCurrentPageMatch() {
    return /\/exam\/error\/practice\/xingce\//.test(window.location.href);
}

// 智能初始化逻辑
function onUrlChange() {
    if (isCurrentPageMatch() && !isInitialized) {
        init();
    } else if (!isCurrentPageMatch() && isInitialized) {
        cleanUpAllResources();
    }
}
```

### 2. 绘画历史管理
**数据结构**：
```javascript
{
    id: Date.now(),                   // 唯一标识
    type: 'pen' | 'eraser',          // 操作类型
    points: [{x, y}, {x, y}, ...],   // 路径点数组
    lineWidth: 2                      // 笔画宽度
}
```

**性能优化**：
- **采样距离限制**：`MIN_POINT_DISTANCE = 3`（第 200 行），每隔 3 像素记录一个点，减少存储和绘制开销
- **历史记录上限**：`MAX_HISTORY = 100`（第 199 行），自动移除最旧记录，防止内存溢出
- **重绘优化**：`redrawAll()` 函数（第 205-231 行）批量重绘历史笔画，支持画笔和橡皮擦两种模式

### 3. Canvas 绘图技术
- **画笔**：`ctx.lineTo()` 连续绘制路径（第 302-303 行）
- **橡皮擦**：`ctx.globalCompositeOperation = 'destination-out'` 实现透明擦除（第 222、281-285、306-311 行）
- **笔画保存**：每个笔画作为独立对象存储到 `drawHistory` 数组（第 198 行）
- **Canvas 自适应**：窗口大小变化或全屏切换时自动调整 Canvas 尺寸并重绘（第 234-248 行）

### 4. 内存管理
**资源清理机制**：
```javascript
const resources = {
    timer: null,          // 自动收起定时器
    clockTimer: null,     // 时钟更新定时器
    elements: [],         // 动态创建的 DOM 元素
    eventListeners: []    // 绑定的事件监听器
};

function cleanUpAllResources() {
    // 1. 清除定时器
    // 2. 移除所有事件监听器
    // 3. 移除所有动态创建的 DOM 元素
    // 4. 重置样式
}
```

**触发时机**：
- 页面卸载（`beforeunload`）
- 路由离开匹配页面（通过 `isInitialized` 标志判断）

### 5. 绘画保留功能
**问题**：关闭笔工具后再打开，画布尺寸变化会导致内容丢失。

**解决方案**：
```javascript
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    redrawAll();  // 重新绘制历史记录
}
```
- 实现位置：第 234-239 行
- 监听窗口 resize 事件和全屏切换事件（第 243-257 行）

### 6. 滚轮支持
**已实现**：画布开启时，如果未在绘制状态，允许通过滚轮滚动底层页面。
- 实现位置：第 354-362 行
- 使用 `preventDefault()` 和 `window.scrollBy()` 实现

---

## 已知限制

1. **触摸设备**：未针对移动端触摸事件进行优化（仅支持鼠标事件）
2. **历史记录上限**：最多保存 100 条操作，超过会自动删除最旧记录
3. **重做功能**：当前版本不支持重做（仅支持撤销）
4. **画笔颜色/粗细**：当前版本固定为红色、2px 线宽，不支持自定义

---

## 版本历史

### 0.4.2 (当前)
- ✅ 修复面板重复创建问题：在 `initDrawTool()` 中添加面板存在性检查，避免移动时重复创建
- ✅ 优化面板管理：确保 `drawCtrlPanel` 永远只有一份，避免重复创建按钮和事件监听器

### 0.4.1
- ✅ 修复画布重复创建问题：确保笔工具按钮和右键功能操作同一个画布
- ✅ 优化画布管理：添加 canvas 存在性检查，避免重复创建多个画布实例

### 0.4.0
- ✅ 修复清屏按钮显示逻辑：初始隐藏，仅在笔工具激活时显示
- ✅ 优化清屏功能：清屏不再关闭画布，只清除标注内容
- ✅ 新增关闭画布按钮（X按钮）：独立的关闭按钮，仅在激活时显示
- ✅ 新增右键快速切换笔工具功能：在非交互元素上右键可打开/关闭画布
- ✅ 完善用户体验：清屏和关闭功能分离，操作更清晰

### 0.3.0
- ✅ 新增全屏时钟功能（可拖动、实时更新）
- ✅ 实现边缘吸附功能（拖动到边缘时自动吸附，隐藏3/4，只露出1/4）
- ✅ 实现鼠标悬停滑出效果（靠近隐藏的时钟时自动滑出显示）
- ✅ 优化时钟UI设计（深色主题，适合白色背景）
- ✅ 时钟初始位置调整为 top: 75px, right: 55px
- ✅ 完善资源清理机制（添加时钟定时器清理）

### 0.2.1
- ✅ 新增右下角悬浮按钮组（收起按钮、全屏按钮）
- ✅ 实现手动收起功能（含内存清理）
- ✅ 实现滚轮支持（画布开启时可滚动页面）
- ✅ 优化按钮交互体验（悬停显示、视觉反馈）
- ✅ 完善资源清理机制

### 0.2.0
- ✅ 新增 SPA 路由监听，解决页面切换时脚本不生效的问题
- ✅ 实现橡皮擦功能
- ✅ 实现撤销功能
- ✅ 实现清屏功能
- ✅ 绘画保留功能（关闭笔工具不丢失笔画）
- ✅ 性能优化（采样距离限制、历史记录上限）

### 0.1.2
- 基础画笔功能
- 自动收起答题区
- 全屏画布

---

## 关键代码位置

| 功能 | 文件位置（行号） |
|------|-----------------|
| 核心收起逻辑 | 21-47 |
| 自动收起定时器 | 50-56 |
| 右下角按钮组（收起+全屏） | 59-177 |
| 画布初始化 | 180-248 |
| 绘画历史管理 | 198-231 |
| 画笔绘制逻辑 | 260-313 |
| 橡皮擦逻辑 | 278-312 |
| 滚轮支持 | 354-362 |
| 笔工具按钮逻辑 | 421-455 |
| 橡皮擦按钮逻辑 | 460-478 |
| 撤销功能 | 481-504 |
| 清屏功能 | 516-533 |
| 面板拖动逻辑 | 538-573 |
| 时钟创建 | 182-312 |
| 时钟拖动和边缘吸附 | 318-473 |
| 时钟显示/隐藏 | 516-528 |
| SPA 路由监听 | 625-697 |
| 资源清理 | 581-609 |

---

## 开发建议

### 后续优化方向
1. **快捷键**：添加 Ctrl+Z 撤销、Ctrl+Shift+Z 重做等快捷键
2. **颜色选择**：支持多种画笔颜色
3. **笔触调节**：支持画笔粗细调节
4. **重做功能**：支持撤销后重做
5. **导出功能**：将标注保存为图片
6. **触摸支持**：针对移动端触摸事件进行优化
7. **多画布**：支持多个独立的标注图层

### 调试方法
打开浏览器控制台，查看以下日志：
- `粉笔行测辅助工具已加载完成` → 脚本初始化成功
- `检测到 URL 变化: [URL]` → 路由监听正常
- `URL 匹配，初始化脚本...` → 自动初始化成功
- `URL 不匹配，清理资源...` → 离开匹配页面，资源已清理

---

## 作者备注

本项目使用 Canvas 2D API 实现标注功能，核心难点在于：
1. SPA 路由监听（已解决）
2. 橡皮擦实现（使用 `destination-out` 混合模式）
3. 历史记录管理和撤销/重做
4. 内存泄漏防护（资源清理机制）
