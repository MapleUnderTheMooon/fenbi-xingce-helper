# 试题、试卷页标注、全屏工具 - 项目说明

## 项目概述

Tampermonkey 用户脚本，为粉笔网试题、试卷页面提供标注工具和全屏功能。

**当前版本**: 0.0.1  
**@match**: `https://spa.fenbi.com/*/exam/*`

---

## 核心功能

### 1. 全屏功能
- 右下角悬浮的"全屏"按钮（鼠标悬停显示）
- 一键进入/退出全屏模式
- 支持浏览器原生全屏 API
- 全屏切换时自动更新按钮文本
- 实现：`createControlButtons()` 函数（第 22-86 行）

### 2. 全屏画布标注系统
点击笔工具按钮后展开全屏画布，支持多种标注模式：

#### 2.1 画笔模式（默认）
- 红色画笔，线宽 2px
- 自由绘制标注
- 记录笔画路径到历史记录
- 自定义画笔光标样式
- 实现：`drawMouseDown`、`drawMouseMove` 函数（第 187-241 行）

#### 2.2 橡皮擦模式
- 使用 `globalCompositeOperation = 'destination-out'` 实现擦除
- 橡皮擦半径 10px
- 同样记录擦除路径到历史记录（可撤销）
- 自定义橡皮擦光标样式（圆形虚线框）
- 实现：`drawMouseDown`、`drawMouseMove` 函数（第 206-240 行）

#### 2.3 撤销功能
- 保存最近 100 条操作历史（`MAX_HISTORY = 100`）
- 点击撤销按钮回退上一步操作
- 支持撤销画笔和橡皮擦操作
- 撤销后自动重绘剩余笔画
- 实现：`undoClick` 函数（第 457-481 行）

#### 2.4 清屏功能
- 一键清除画布上所有内容
- 清空历史记录
- 不清关闭画布，保持笔工具激活状态
- 实现：`clearClick` 函数（第 492-500 行）

#### 2.5 关闭画布按钮
- 独立的关闭按钮（X按钮），仅在笔工具激活时显示
- 点击后关闭画布并重置所有状态
- 实现：`closeClick` 函数（第 532-537 行）

#### 2.6 右键快速切换功能
- 在页面非交互元素上右键可快速打开/关闭笔工具
- 自动排除按钮、链接等可交互元素，避免误触
- 在画布上右键可关闭画布
- 实现：`rightClickToTogglePen` 函数（第 390-434 行）

#### 2.7 面板拖动功能
- 标注工具面板可拖动（点击非按钮区域）
- 自动限制在窗口范围内
- 实现：`panelMouseDown`、`panelMouseMove`、`panelMouseUp` 函数（第 548-586 行）

### 3. UI 交互设计

#### 3.1 标注工具面板（右上角，可拖动）
- **主按钮**：笔工具（点击激活/关闭）
- **子按钮展开**：点击笔工具后展开显示
  - 橡皮擦按钮（🧽 橡皮擦）
  - 撤销按钮（↩ 撤销）
- **独立按钮**：仅在笔工具激活时显示
  - 清屏按钮（清屏（×））：清除所有标注，不关闭画布
  - 关闭按钮（X）：关闭画布并重置状态
- **视觉反馈**：
  - 当前选中模式高亮显示（笔模式：蓝色，橡皮擦模式：橙色）
  - 按钮状态切换（展开/收起）
  - 撤销按钮点击时闪烁反馈

#### 3.2 右下角悬浮按钮
- **全屏按钮**：蓝色圆形按钮，鼠标悬停显示
- 按钮默认隐藏在右侧，悬停时滑出

---

## 技术实现要点

### 1. SPA 路由监听（重要）
**问题**：Tampermonkey 的 `@match` 只在页面初次加载时触发，粉笔网是单页应用，路由切换时脚本不会重新初始化。

**解决方案**（三层防护）：
```javascript
// 1. 劫持 History API
history.pushState = function() {
    originalPushState.apply(this, arguments);
    window.dispatchEvent(new Event('urlchange'));
};

// 2. 监听浏览器原生事件
window.addEventListener('popstate', ...);      // 前进/后退
window.addEventListener('hashchange', ...);    // Hash 路由

// 3. URL 匹配检测
function isCurrentPageMatch() {
    return /\/exam\//.test(window.location.href);
}

// 智能初始化逻辑
function onUrlChange() {
    if (isCurrentPageMatch() && !isInitialized) {
        init();
    } else if (!isCurrentPageMatch() && isInitialized) {
        cleanUpAllResources();
    }
}
```

### 2. 绘画历史管理
**数据结构**：
```javascript
{
    id: Date.now(),                   // 唯一标识
    type: 'pen' | 'eraser',          // 操作类型
    points: [{x, y}, {x, y}, ...],   // 路径点数组
    lineWidth: 2                      // 笔画宽度
}
```

**性能优化**：
- **采样距离限制**：`MIN_POINT_DISTANCE = 3`（第 118 行），每隔 3 像素记录一个点，减少存储和绘制开销
- **历史记录上限**：`MAX_HISTORY = 100`（第 117 行），自动移除最旧记录，防止内存溢出
- **重绘优化**：`redrawAll()` 函数（第 122-149 行）批量重绘历史笔画，支持画笔和橡皮擦两种模式

### 3. Canvas 绘图技术
- **画笔**：`ctx.lineTo()` 连续绘制路径（第 229-231 行）
- **橡皮擦**：`ctx.globalCompositeOperation = 'destination-out'` 实现透明擦除（第 139-146、208-213、233-239 行）
- **笔画保存**：每个笔画作为独立对象存储到 `drawHistory` 数组（第 116 行）
- **Canvas 自适应**：窗口大小变化或全屏切换时自动调整 Canvas 尺寸并重绘（第 151-185 行）

### 4. 内存管理
**资源清理机制**：
```javascript
const resources = {
    elements: [],         // 动态创建的 DOM 元素
    eventListeners: []    // 绑定的事件监听器
};

function cleanUpAllResources() {
    // 1. 移除所有事件监听器
    // 2. 移除所有动态创建的 DOM 元素
    // 3. 重置样式
}
```

**触发时机**：
- 页面卸载（`beforeunload`）
- 路由离开匹配页面（通过 `isInitialized` 标志判断）

### 5. 绘画保留功能
**问题**：关闭笔工具后再打开，画布尺寸变化会导致内容丢失。

**解决方案**：
```javascript
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    redrawAll();  // 重新绘制历史记录
}
```
- 实现位置：第 151-157 行
- 监听窗口 resize 事件和全屏切换事件（第 160-185 行）

### 6. 滚轮支持
**已实现**：画布开启时，如果未在绘制状态，允许通过滚轮滚动底层页面。
- 实现位置：第 282-290 行
- 使用 `passive: true` 选项，不阻止默认滚轮行为

---

## 已知限制

1. **触摸设备**：未针对移动端触摸事件进行优化（仅支持鼠标事件）
2. **历史记录上限**：最多保存 100 条操作，超过会自动删除最旧记录
3. **重做功能**：当前版本不支持重做（仅支持撤销）
4. **画笔颜色/粗细**：当前版本固定为红色、2px 线宽，不支持自定义

---

## 版本历史

### 0.0.1 (当前)
- ✅ 基础全屏功能
- ✅ 全屏画布标注系统（画笔、橡皮擦、撤销、清屏）
- ✅ 右键快速切换笔工具
- ✅ 面板拖动功能
- ✅ SPA 路由监听
- ✅ 完整的资源清理机制

---

## 关键代码位置

| 功能 | 文件位置（行号） |
|------|-----------------|
| 全屏按钮 | 22-86 |
| 画布初始化 | 88-109 |
| 绘画历史管理 | 116-149 |
| 画笔绘制逻辑 | 187-241 |
| 橡皮擦逻辑 | 206-240 |
| 滚轮支持 | 282-290 |
| 笔工具按钮逻辑 | 355-388 |
| 橡皮擦按钮逻辑 | 436-455 |
| 撤销功能 | 457-481 |
| 清屏功能 | 492-500 |
| 面板拖动逻辑 | 548-586 |
| SPA 路由监听 | 630-701 |
| 资源清理 | 593-615 |

---

## 开发建议

### 后续优化方向
1. **快捷键**：添加 Ctrl+Z 撤销、Ctrl+Shift+Z 重做等快捷键
2. **颜色选择**：支持多种画笔颜色
3. **笔触调节**：支持画笔粗细调节
4. **重做功能**：支持撤销后重做
5. **导出功能**：将标注保存为图片
6. **触摸支持**：针对移动端触摸事件进行优化
7. **多画布**：支持多个独立的标注图层

### 调试方法
打开浏览器控制台，查看以下日志：
- `试题、试卷页标注、全屏工具已加载完成` → 脚本初始化成功
- `检测到 URL 变化: [URL]` → 路由监听正常
- `URL 匹配，初始化脚本...` → 自动初始化成功
- `URL 不匹配，清理资源...` → 离开匹配页面，资源已清理

---

## 作者备注

本项目使用 Canvas 2D API 实现标注功能，核心难点在于：
1. SPA 路由监听（已解决）
2. 橡皮擦实现（使用 `destination-out` 混合模式）
3. 历史记录管理和撤销功能
4. 内存泄漏防护（资源清理机制）

