# 试题、试卷页标注、全屏工具 - 项目说明

## 项目概述

Tampermonkey 用户脚本，为粉笔网试题、试卷页面提供标注工具和全屏功能。

**当前版本**: 0.0.7  
**@match**: `https://spa.fenbi.com/*/exam/*`

---

## 核心功能

### 1. 全屏功能
- 右下角悬浮的"全屏"按钮（鼠标悬停显示）
- 一键进入/退出全屏模式
- 支持浏览器原生全屏 API
- 全屏切换时自动更新按钮文本
- 实现：`createControlButtons()` 函数

### 2. 全屏画布标注系统
笔工具默认显示，位于右侧65px，顶部160px，鼠标悬停时展开子按钮面板：

#### 2.1 画笔模式（默认）
- 红色画笔，线宽 2px
- 自由绘制标注
- 记录笔画路径到历史记录
- 自定义画笔光标样式

#### 2.2 橡皮擦模式
- 使用 `globalCompositeOperation = 'destination-out'` 实现擦除
- 橡皮擦半径 10px
- 同样记录擦除路径到历史记录（可撤销）
- 自定义橡皮擦光标样式（圆形虚线框）

#### 2.3 撤销功能
- 保存最近 100 条操作历史（`MAX_HISTORY = 100`）
- 点击撤销按钮回退上一步操作
- 支持撤销画笔和橡皮擦操作
- 撤销后自动重绘剩余笔画

#### 2.4 清屏功能
- 一键清除画布上所有内容
- 清空历史记录
- 不清关闭画布，保持笔工具激活状态
- 清屏按钮高度60px，更加醒目

#### 2.5 关闭画布按钮
- 独立的关闭按钮（X按钮），位于展开面板中
- 点击后关闭画布并重置所有状态

#### 2.6 右键快速切换功能
- 在页面非交互元素上右键可快速打开/关闭笔工具
- 自动排除按钮、链接等可交互元素，避免误触
- 在画布上右键可关闭画布

#### 2.7 面板拖动功能
- 支持鼠标拖动圆球到屏幕任意位置
- 拖动时显示视觉反馈
- 自动限制在窗口范围内

#### 2.8 悬停展开功能
- 鼠标悬停圆球时自动展开子按钮面板
- 平滑的展开动画效果
- 鼠标离开时自动收起

#### 2.9 全屏支持
- 添加全屏事件处理，确保全屏模式下正常工作
- 自动调整canvas大小和位置

### 3. UI 交互设计

#### 3.1 标注工具面板（右上角，可拖动）
- **主按钮**：收缩式蓝色圆球设计（默认显示），位于右侧65px，顶部160px
- **悬停展开**：鼠标悬停圆球时展开子按钮面板
- **子按钮**：
  - 橡皮擦按钮（🧽 橡皮擦）：灰色系，直观表示擦除
  - 撤销按钮（↩ 撤销）：蓝色系，直观表示返回操作
- **独立按钮**：
  - 清屏按钮（🗑️ 清屏）：橙色系，高度60px，更加醒目
  - 关闭按钮（❌ 关闭）：红色系，直观表示关闭操作
- **拖动功能**：支持鼠标拖动圆球到屏幕任意位置
- **视觉反馈**：
  - 按钮采用iPhone风格的柔和配色
  - 悬停时平滑展开动画
  - 操作时按钮状态变化反馈

#### 3.2 右下角悬浮按钮
- **全屏按钮**：蓝色圆形按钮，鼠标悬停显示
- 按钮默认隐藏在右侧，悬停时滑出

---

## 技术实现要点

### 1. SPA 路由监听（重要）
**问题**：Tampermonkey 的 `@match` 只在页面初次加载时触发，粉笔网是单页应用，路由切换时脚本不会重新初始化。

**解决方案**（三层防护）：
```javascript
// 1. 劫持 History API
history.pushState = function() {
    originalPushState.apply(this, arguments);
    window.dispatchEvent(new Event('urlchange'));
};

// 2. 监听浏览器原生事件
window.addEventListener('popstate', ...);      // 前进/后退
window.addEventListener('hashchange', ...);    // Hash 路由

// 3. URL 匹配检测
function isCurrentPageMatch() {
    return /\/exam\//.test(window.location.href);
}

// 智能初始化逻辑
function onUrlChange() {
    if (isCurrentPageMatch() && !isInitialized) {
        init();
    } else if (!isCurrentPageMatch() && isInitialized) {
        cleanUpAllResources();
    }
}
```

### 2. 绘画历史管理
**数据结构**：
```javascript
{
    id: Date.now(),                   // 唯一标识
    type: 'pen' | 'eraser',          // 操作类型
    points: [{x, y}, {x, y}, ...],   // 路径点数组
    lineWidth: 2                      // 笔画宽度
}
```

**性能优化**：
- **采样距离限制**：`MIN_POINT_DISTANCE = 3`，每隔 3 像素记录一个点，减少存储和绘制开销
- **历史记录上限**：`MAX_HISTORY = 100`，自动移除最旧记录，防止内存溢出
- **重绘优化**：`redrawAll()` 函数批量重绘历史笔画，支持画笔和橡皮擦两种模式

### 3. Canvas 绘图技术
- **画笔**：`ctx.lineTo()` 连续绘制路径
- **橡皮擦**：`ctx.globalCompositeOperation = 'destination-out'` 实现透明擦除
- **笔画保存**：每个笔画作为独立对象存储到 `drawHistory` 数组
- **Canvas 自适应**：窗口大小变化或全屏切换时自动调整 Canvas 尺寸并重绘

### 4. 事件监听器管理
- **动态添加/移除**：拖动功能使用动态添加/移除 `mousemove` 和 `mouseup` 事件监听器
- **性能优化**：减少不必要的事件监听器，提高页面响应速度
- **资源清理**：确保所有事件监听器在不需要时正确移除

### 5. 内存管理
**资源清理机制**：
```javascript
const resources = {
    elements: [],         // 动态创建的 DOM 元素
    eventListeners: []    // 绑定的事件监听器
};

function cleanUpAllResources() {
    // 1. 移除所有事件监听器
    // 2. 移除所有动态创建的 DOM 元素
    // 3. 重置样式
}
```

**触发时机**：
- 页面卸载（`beforeunload`）
- 路由离开匹配页面（通过 `isInitialized` 标志判断）

### 6. 绘画保留功能
**问题**：关闭笔工具后再打开，画布尺寸变化会导致内容丢失。

**解决方案**：
```javascript
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    redrawAll();  // 重新绘制历史记录
}
```
- 实现：监听窗口 resize 事件和全屏切换事件

### 7. 滚轮支持
**已实现**：画布开启时，如果未在绘制状态，允许通过滚轮滚动底层页面。
- 使用 `passive: true` 选项，不阻止默认滚轮行为

---

## 已知限制

1. **触摸设备**：未针对移动端触摸事件进行优化（仅支持鼠标事件）
2. **历史记录上限**：最多保存 100 条操作，超过会自动删除最旧记录
3. **重做功能**：当前版本不支持重做（仅支持撤销）
4. **画笔颜色/粗细**：当前版本固定为红色、2px 线宽，不支持自定义

---

## 版本历史

### 0.0.7 (当前)
- ✅ 版本号：从 0.0.6 更新到 0.0.7
- ✅ 空格键功能修复：解决按空格键同时触发两个按钮的问题
- ✅ 函数优化：将 `handleSpacePress` 函数移到 `init` 函数外部，避免重复创建函数实例
- ✅ 事件监听器优化：确保只绑定一个事件监听器实例，防止重复触发
- ✅ 按钮状态管理：点击一个按钮后隐藏并显示相对的另一个按钮

### 0.0.6
- ✅ 版本号：从 0.0.5 更新到 0.0.6
- ✅ 空格键功能：添加空格键触发按钮点击功能
- ✅ 智能检测：实时检查可见按钮并在点击后隐藏
- ✅ 按钮状态切换：点击暂停按钮后显示继续作答按钮，反之亦然

### 0.0.5
- ✅ 版本号：从 0.0.4 更新到 0.0.5
- ✅ 代码优化：重构事件处理逻辑
- ✅ 性能提升：优化Canvas重绘机制

### 0.0.4
- ✅ 版本号：从 0.0.3 更新到 0.0.4
- ✅ UI设计：将笔工具面板改为收缩式圆球设计
- ✅ 默认位置：右侧65px，顶部160px
- ✅ 按钮样式：采用iPhone风格的柔和配色按钮
- ✅ 清屏按钮：单独增加高度到60px，更加醒目
- ✅ 悬停展开：鼠标悬停圆球时展开子按钮面板
- ✅ 拖动功能：支持鼠标拖动圆球到屏幕任意位置，动态添加/移除事件监听器
- ✅ 全屏支持：添加全屏事件处理，确保全屏模式下正常工作
- ✅ 右键菜单：保持右键快速打开/关闭笔工具功能
- ✅ 智能展开：展开容器位置自动调整，避免超出屏幕
- ✅ 动画效果：悬停时平滑展开/收起动画

### 0.0.3
- ✅ 初始版本
- ✅ 基础画笔功能
- ✅ 橡皮擦功能
- ✅ 撤销功能
- ✅ 清屏功能
- ✅ 全屏按钮
- ✅ SPA 路由监听

---

## 开发建议

### 后续优化方向
1. **快捷键**：添加 Ctrl+Z 撤销、Ctrl+Shift+Z 重做等快捷键
2. **颜色选择**：支持多种画笔颜色
3. **笔触调节**：支持画笔粗细调节
4. **重做功能**：支持撤销后重做
5. **导出功能**：将标注保存为图片
6. **触摸支持**：针对移动端触摸事件进行优化
7. **多画布**：支持多个独立的标注图层

### 调试方法
打开浏览器控制台，查看以下日志：
- `试题、试卷页标注、全屏工具已加载完成` → 脚本初始化成功
- `检测到 URL 变化: [URL]` → 路由监听正常
- `URL 匹配，初始化脚本...` → 自动初始化成功
- `URL 不匹配，清理资源...` → 离开匹配页面，资源已清理

---

## 作者备注

本项目使用 Canvas 2D API 实现标注功能，核心难点在于：
1. SPA 路由监听（已解决）
2. 橡皮擦实现（使用 `destination-out` 混合模式）
3. 历史记录管理和撤销功能
4. 内存泄漏防护（资源清理机制）

